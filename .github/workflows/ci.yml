# Terraform CI Pipeline
# This pipeline is dedicated to Continuous Integration (CI) for Terraform configurations.
# It performs the following tasks:
# - Detects changes in specific directories (`modules/**` and `examples/dev/**`).
# - Runs `terraform fmt` to ensure code formatting.
# - Validates Terraform configurations (`terraform init` and `terraform validate`).
# - Lints Terraform code using TFLint.
# - Performs a security scan using tfsec.
# The pipeline is triggered on pull requests and pushes to specific branches.

name: Terraform CI

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'modules/**'
      - 'examples/dev/**'
  push:
    branches:
      - 'main'
      - 'feature/**'
    paths:
      - 'modules/**'
      - 'examples/dev/**'

jobs:
  # Detect which directories changed
  filter:
    name: üîÄ Path filter
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.filter.outputs.modules }}
      examples: ${{ steps.filter.outputs.examples }}
    steps:
      - uses: actions/checkout@v3
      - id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            modules:
              - 'modules/**'
            examples:
              - 'examples/dev/**'

  # Run terraform fmt for modules
  fmt-modules:
    name: üñ®Ô∏è fmt ‚Üí modules
    needs: filter
    runs-on: ubuntu-latest
    # Only run if this is a push event or if changes were detected in the modules directory
    if: |
      github.event_name == 'push' || needs.filter.outputs.modules == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
      - name: terraform fmt (modules)
        run: terraform fmt -check -recursive modules

  # Run terraform fmt for examples/dev
  fmt-examples:
    name: üñ®Ô∏è fmt ‚Üí examples/dev
    needs: filter
    runs-on: ubuntu-latest
    # Only run if this is a push event or if changes were detected in the examples/dev directory
    if: |
      github.event_name == 'push' || needs.filter.outputs.examples == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
      - name: terraform fmt (examples/dev)
        run: terraform fmt -check -recursive examples/dev

  # Validate Terraform configurations for modules
  validate-modules:
    name: ‚úÖ validate ‚Üí modules
    needs: [filter, fmt-modules]
    runs-on: ubuntu-latest
    # Only run if this is a push event or if changes were detected in the modules directory
    if: |
      github.event_name == 'push' || needs.filter.outputs.modules == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
      - name: Init & validate (modules)
        run: |
          cd modules
          terraform init -backend=false
          terraform validate

  # Validate Terraform configurations for examples/dev
  validate-examples:
    name: ‚úÖ validate ‚Üí examples/dev
    needs: [filter, fmt-examples]
    runs-on: ubuntu-latest
    # Only run if this is a push event or if changes were detected in the examples/dev directory
    if: |
      github.event_name == 'push' || needs.filter.outputs.examples == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
      - name: Init & validate (examples/dev)
        run: |
          cd examples/dev
          terraform init -backend=false
          terraform validate

  # Lint Terraform code using TFLint
  lint:
    name: üîç TFLint
    needs: [filter, validate-examples] # Removed validate-modules
    runs-on: ubuntu-latest
    # Only run if changes were detected in either modules or examples/dev
    if: |
      github.event_name == 'push' ||
      needs.filter.outputs.modules == 'true' ||
      needs.filter.outputs.examples == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
      - name: TFLint init
        run: tflint --init
      - name: Lint modules
        if: needs.filter.outputs.modules == 'true' # Only lint modules if changes were detected
        run: tflint --chdir=modules
      - name: Lint examples/dev
        if: needs.filter.outputs.examples == 'true' # Only lint examples/dev if changes were detected
        run: tflint --chdir=examples/dev

  # Perform a security scan using tfsec
  tfsec:
    name: üîí tfsec scan
    needs: [filter, validate-examples] # Removed validate-modules
    runs-on: ubuntu-latest
    # Only run if changes were detected in either modules or examples/dev
    if: |
      github.event_name == 'push' ||
      needs.filter.outputs.modules == 'true' ||
      needs.filter.outputs.examples == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run tfsec (all .tf)
        if: needs.filter.outputs.examples == 'true' # Only scan examples/dev if changes were detected
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: examples/dev
          soft_fail: true