name: Terraform CI â€” Change Detector

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  filter:
    name: ðŸ”€ Detect what changed in this PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read         # needed so paths-filter can call the API
    outputs:
      s3_bucket: ${{ steps.detect.outputs.s3_bucket }}
      ssm_parameter: ${{ steps.detect.outputs.ssm_parameter }}
      other: ${{ steps.determine_other.outputs.other }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changes
        id: detect
        uses: dorny/paths-filter@v3
        with:
          filters: |
            s3_bucket:
              - 'modules/s3_bucket/**'
            ssm_parameter:
              - 'modules/ssm_parameter/**'
            other:
              - '**'
              - '!modules/s3_bucket/**'
              - '!modules/ssm_parameter/**'
              - '.github/**' # Include .github directory in the 'other' filter

      - name: Determine if 'other' changed
        id: determine_other
        run: |
          if [[ "${{ steps.detect.outputs.s3_bucket }}" == "false" && "${{ steps.detect.outputs.ssm_parameter }}" == "false" ]]; then
            echo "other=true" >> $GITHUB_OUTPUT
          else
            echo "other=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug outputs
        run: |
          echo "â†’ s3_bucket changed?     ${{ steps.detect.outputs.s3_bucket }}"
          echo "â†’ ssm_parameter changed?  ${{ steps.detect.outputs.ssm_parameter }}"
          echo "â†’ other changed?         ${{ steps.determine_other.outputs.other }}"