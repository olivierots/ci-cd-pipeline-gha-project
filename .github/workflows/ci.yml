name: Terraform CI â€” Change Detector

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  filter:
    name: ðŸ”€ Detect what changed in this PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read         # needed so paths-filter can call the API
    outputs:
      s3_bucket:    ${{ steps.detect.outputs.s3_bucket }}
      ssm_parameter:${{ steps.detect.outputs.ssm_parameter }}
      other:        ${{ steps.detect.outputs.other }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changes
        id: detect
        uses: dorny/paths-filter@v3
        with:
          filters: |
            s3_bucket:
              - 'modules/s3_bucket/**'
            ssm_parameter:
              - 'modules/ssm_parameter/**'
            other:
              - '**'
              - '!modules/s3_bucket/**'
              - '!modules/ssm_parameter/**'

      - name: Debug matched files
        run: |
          echo "Matched files for s3_bucket:"
          echo "${{ steps.detect.outputs.s3_bucket_files }}"
          echo "Matched files for ssm_parameter:"
          echo "${{ steps.detect.outputs.ssm_parameter_files }}"
          echo "Matched files for other:"
          echo "${{ steps.detect.outputs.other_files }}"

      - name: Report
        run: |
          echo "â†’ modules/s3_bucket changed?     ${{ steps.detect.outputs.s3_bucket }}"
          echo "â†’ modules/ssm_parameter changed?  ${{ steps.detect.outputs.ssm_parameter }}"
          echo "â†’ everything else (full CI)?      ${{ steps.detect.outputs.other }}"